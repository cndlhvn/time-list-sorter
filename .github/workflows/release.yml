name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Create release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        tag="${GITHUB_REF#refs/tags/}"
        gh release create "$tag" \
            --title="Release $tag" \
            --generate-notes \
            main.js \
            manifest.json

  # プロダクション用の追加ジョブ：サイズチェックとテスト
  validate:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Check build artifacts
      run: |
        if [ ! -f main.js ]; then
          echo "main.js not found!"
          exit 1
        fi
        if [ ! -f manifest.json ]; then
          echo "manifest.json not found!"
          exit 1
        fi
        echo "✅ All required files are present"
        
    - name: Check file sizes
      run: |
        mainjs_size=$(wc -c < main.js)
        echo "main.js size: $mainjs_size bytes"
        if [ $mainjs_size -lt 1000 ]; then
          echo "Warning: main.js seems too small"
          exit 1
        fi
        echo "✅ File size check passed"
